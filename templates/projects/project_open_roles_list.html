{% extends "base.html" %}
{% block content %}
<div class="d-grid gap-3" style="grid-template-columns: 1fr 3fr;">
  <div class="bg-body-tertiary border rounded-3 sticky-top" style="min-height: 100px; padding: 15px;">
    <form action="" method="get">
      {{ search_form }}
      <input type="submit">
    </form>
  </div>
  <div class="bg-body-tertiary border rounded-3" style="min-height: 100px; padding: 15px;">
    <h2>All Opportunities</h2>
    {% if open_roles %}
      <ul class="list-group">
        {% for role in open_roles %}
          <li>
            <h3>
              {{ role.role_name }}
            </h3>
          <p>
            {{ role.message }}
          </p>
          <button class="btn btn-danger mb-3"
            data-bs-toggle="modal"
            data-bs-target="#deleteModal"
            data-url="{% url 'projects:project_open_roles_delete' project.pk role.pk %}">
                Delete
          </button>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <h4>No opportunities yet.</h4>
    {% endif %}
    {% include "includes/pagination.html" %}
  </div>
</div>

<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Deletion</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete "<strong>{{ role.role_name }}</strong>"?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDelete">Yes, delete</button>
      </div>
    </div>
  </div>
</div>
  <script>
    const deleteModal = document.getElementById('deleteModal');
    let deleteUrl = null;

    deleteModal.addEventListener('show.bs.modal', event => {
      const button = event.relatedTarget;
      deleteUrl = button.getAttribute('data-url');
      const roleName = button.closest('li').querySelector('h3').textContent;
      deleteModal.querySelector('.modal-body strong').textContent = roleName;
    });

    document.getElementById('confirmDelete').addEventListener('click', () => {
      if (!deleteUrl) return;

      fetch(deleteUrl, {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}',
        },
      }).then(res => {
        if (res.ok) location.reload();
        else alert('Error deleting role');
      });
    });
  </script>
{% endblock %}