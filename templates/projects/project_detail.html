{% extends "base.html" %}
{% block content %}
{% if project %}
<h2>{{ project.name }}</h2>
<p>{{ project.description }}</p>
<p><strong>Stage:</strong> {{ project.development_stage }}</p>
<p><strong>Owner:</strong> {{ project.owner.username }}</p>
<p><strong>Links:</strong> {{ project.project_url }}</p>
{% if project.deploy_url %}
  <p><strong>Deploy:</strong> {{ project.deploy_url }}</p>
{% endif %}
<p><strong>Created at:</strong> {{ project.created_at }}</p>
<p><strong>Score:</strong> {{ project.score }}</p>
<hr>

<h4>Team Members</h4>
<ul>
  {% for membership in memberships %}
    <li>
      <a href="{% url 'projects:profile' membership.user.pk %}">
        {{ membership.user.username }}
      </a> – {{ membership.get_role_display }}
    </li>
  {% empty %}
    <li>No members yet.</li>
  {% endfor %}
</ul>

<a href="{% url 'projects:project_edit' project.pk %}" class="btn btn-secondary mb-3">Edit Project Info</a>
<a href="{% url 'projects:project_edit_roles' project.pk %}" class="btn btn-warning mb-3">Edit Roles</a>
<a href="{% url 'projects:task_create' project.pk %}" class="btn btn-primary mb-3">Add Task</a>
<a href="{% url 'projects:project_edit_stage' project.pk%}" class="btn btn-secondary mb-3">Update Stage</a>



{% if current_membership and current_membership.role in "LEAD,PM,Mentor" %}
  <a href="{% url 'projects:project_edit' project.pk %}" class="btn btn-secondary mb-3">Edit Project Info</a>
  <a href="{% url 'projects:project_edit_stage' project.pk%}">Update Stage</a>
  <a href="{% url 'projects:task_create' project.pk %}" class="btn btn-primary mb-3">Add Task</a>
{% endif %}

<h3>We are open for:</h3>
{% if can_applicate %}
  <button class="btn btn-primary"
        hx-get="{% url 'projects:apply' project.pk %}"
        hx-target="#modal-body"
        hx-trigger="click"
        data-bs-toggle="modal"
        data-bs-target="#applicationModal">
    Подать заявку
</button>
{% endif %}

<div class="modal fade" id="applicationModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Applicate</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
      </div>
      <div class="modal-body" id="modal-body">
        <div class="text-center p-3">Загрузка...</div>
      </div>
    </div>
  </div>
</div>

<hr>

<h4>Tasks grouped by Assignee</h4>
<ul>
  {% for assignee, tasks in tasks_by_assignee.items %}
    <li>
      <strong>{{ assignee }}</strong>
      <ul>
        {% for task in tasks %}
          <li>
            {{ task.title }} – {{ task.get_status_display }}
            {% if task.tags.all %}
              (Tags: {% for tag in task.tags.all %}
                {{ tag.name }}{% if not forloop.last %}, {% endif %}
              {% endfor %})
            {% endif %}
            <a href="{% url 'projects:task_detail' task.pk %}">See</a>
            {% if current_membership and current_membership.role in "LEAD,PM,Mentor" %}
              <a href="{% url 'projects:task_edit' task.pk %}">Edit</a>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    </li>
  {% empty %}
    <li>No tasks yet.</li>
  {% endfor %}
</ul>
<h3>Ratings:</h3>
<ul>
  {% for rating in project.ratings.all %}
    <li>{{ rating.user.username }} – Score: {{ rating.score }}
        {% if rating.comment %}- Comment: {{ rating.comment }}{% endif %}
    </li>
  {% empty %}
    <li>No ratings yet.</li>
  {% endfor %}
</ul>

{% if can_rate %}
  <button class="btn btn-primary"
          hx-get="{% url 'projects:project_rate' project.pk %}"
          hx-target="#rating-dialog">
    Rate this project
  </button>
{% endif %}

<div class="modal fade" id="ratingModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content" id="rating-dialog">
      <div class="modal-header">
        <h5 class="modal-title">Rate Project</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
      </div>
    </div>
  </div>
</div>


{% else %}
  <p>We don’t find this project</p>
{% endif %}
{% endblock %}
