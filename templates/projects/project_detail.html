{% extends "base.html" %}
{% block content %}
{% if project %}
<div class="d-grid gap-3" style="grid-template-columns: 1fr 2fr;">
  <div class="bg-body-tertiary border rounded-3 sticky-top"
     style="padding: 15px; height: fit-content; top: 20px;">
    <h2>{{ project.name }}</h2>
      <p>{{ project.description }}</p>
      <p><strong>Stage:</strong> {{ project.development_stage }}</p>
      <p><strong>Domain:</strong> {{ project.domain }}</p>
      <p><strong>Owner:</strong> {{ project.owner.username }}</p>
      <p><strong>Links:</strong> {{ project.project_url }}</p>
      {% if project.deploy_url %}
        <p><strong>Deploy:</strong> {{ project.deploy_url }}</p>
      {% endif %}
      <p><strong>Created at:</strong> {{ project.created_at }}</p>
      <p><strong>Score:</strong> {{ project.score }}</p>
      <hr>
      <a href="{% url 'projects:project_edit' project.pk %}" class="btn btn-secondary mb-3">Edit Project Info</a>
      <a href="{% url 'projects:project_edit_roles' project.pk %}" class="btn btn-warning mb-3">Edit Roles</a>
      <a href="{% url 'projects:task_create' project.pk %}" class="btn btn-primary mb-3">Add Task</a>
      <a href="{% url 'projects:project_edit_stage' project.pk%}" class="btn btn-secondary mb-3">Update Stage</a>
      <a href="{% url 'projects:project_open_roles_list' project.pk%}" class="btn btn-secondary mb-3">Manage Open Roles</a>

      <h4>Team'Mates</h4>
      {% if memberships %}
      <ul>
        {% for membership in memberships %}
          <li>
            <a href="{% url 'users:profile' membership.user.pk %}">
              {{ membership.user.username }}
            </a> – {{ membership.get_role_display }}
          </li>
        {% empty %}
          <li>No members yet.</li>
        {% endfor %}
      </ul>
      {% else %}
        <p>No Team'Mates yet.</p>
      {% endif %}
  </div>
  <div class="bg-body-tertiary border rounded-3" style="padding: 15px; height: fit-content;">
    {% if  tasks %}
      <h4>Tasks for Team'Mates</h4>
      {% if tasks.count > 7 %}
        <a href="{% url 'projects:task_list' project.pk %}" class="btn btn-secondary mb-3">Check All Tasks</a>
      {% endif %}
      <ul style="padding-top: 10px;">
        {% for task in tasks %}
          {% include "includes/task-card.html" %}
        {% endfor %}
      </ul>
    {% else %}
      <h2>No tasks yet.</h2>
    {% endif %}
  </div>
</div>
{% if open_roles and ratings %}
  <div class="d-grid gap-3" style="grid-template-columns: 1fr 2fr;">
    <div class="bg-body-tertiary border rounded-3 sticky-top" style="min-height: 100px; padding: 15px; margin-top: 15px;">
      {% include "includes/open-project-roles.html" %}
    </div>
    <div class="bg-body-tertiary border rounded-3" style="min-height: 100px; padding: 15px; margin-top: 15px;">
      <h3>Ratings:</h3>
      {% include "includes/rate-project.html" %}
    </div>
  </div>
{% elif ratings %}
<div class="bg-body-tertiary border rounded-3" style="min-height: 100px; padding: 15px; margin-top: 15px;">
  <h3>Ratings:</h3>
  {% include "includes/rate-project.html" %}
</div>
{% endif %}

<div class="modal fade" id="applicationModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Applicate</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
      </div>
      <div class="modal-body" id="modal-body">
        <div class="text-center p-3">Loading...</div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="ratingModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Rate Project</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="ratingModalBody">
        <div class="text-center p-3">Loading...</div>
      </div>
    </div>
  </div>
</div>

{% else %}
  <p>We don’t find this project</p>
{% endif %}
  <script>
document.addEventListener("DOMContentLoaded", () => {
  const ratingModal = document.getElementById('ratingModal');
  const modalBody = document.getElementById('ratingModalBody');

  ratingModal.addEventListener('show.bs.modal', event => {
    const url = "{% url 'projects:project_rate' project.pk %}";

    fetch(url)
      .then(res => res.text())
      .then(html => {
        modalBody.innerHTML = html;

        const form = modalBody.querySelector('form');
        form.addEventListener('submit', e => {
          e.preventDefault();

          fetch(url, {
            method: 'POST',
            body: new FormData(form),
            headers: {
              'X-CSRFToken': '{{ csrf_token }}'
            }
          }).then(res => {
            if (res.ok) {
              location.reload();
            } else {
              res.text().then(html => modalBody.innerHTML = html);
            }
          });
        });
      });
  });
});
</script>
{% endblock %}
