{% extends "base.html" %}
{% block content %}
{% if project %}
<div class="d-grid gap-3" style="grid-template-columns: 1fr 2fr;">
  <div class="bg-body-tertiary border rounded-3 sticky-top" style="min-height: 100px; padding: 15px;">
    <h2>{{ project.name }}</h2>
      <p>{{ project.description }}</p>
      <p><strong>Stage:</strong> {{ project.development_stage }}</p>
      <p><strong>Owner:</strong> {{ project.owner.username }}</p>
      <p><strong>Links:</strong> {{ project.project_url }}</p>
      {% if project.deploy_url %}
        <p><strong>Deploy:</strong> {{ project.deploy_url }}</p>
      {% endif %}
      <p><strong>Created at:</strong> {{ project.created_at }}</p>
      <p><strong>Score:</strong> {{ project.score }}</p>
      <hr>
      <a href="{% url 'projects:project_edit' project.pk %}" class="btn btn-secondary mb-3">Edit Project Info</a>
      <a href="{% url 'projects:project_edit_roles' project.pk %}" class="btn btn-warning mb-3">Edit Roles</a>
      <a href="{% url 'projects:task_create' project.pk %}" class="btn btn-primary mb-3">Add Task</a>
      <a href="{% url 'projects:project_edit_stage' project.pk%}" class="btn btn-secondary mb-3">Update Stage</a>

      <h4>Team Members</h4>
      <ul>
        {% for membership in memberships %}
          <li>
            <a href="{% url 'projects:profile' membership.user.pk %}">
              {{ membership.user.username }}
            </a> – {{ membership.get_role_display }}
          </li>
        {% empty %}
          <li>No members yet.</li>
        {% endfor %}
      </ul>
  </div>
  <div class="bg-body-tertiary border rounded-3" style="padding: 15px">
    {% if  tasks %}
      <h4>Tasks grouped by Assignee</h4>
      {% if tasks.count > 5 %}
        <a href="{% url 'projects:project_edit' project.pk %}" class="btn btn-secondary mb-3">Check All Tasks</a>
      {% endif %}
      <ul style="padding-top: 10px;">
        {% for task in tasks %}
          {% include "includes/task-card.html" %}
        {% empty %}
          <li>No tasks yet.</li>
        {% endfor %}
      </ul>
    {% else %}
      <h2>No tasks yet.</h2>
    {% endif %}
  </div>
</div>
<div class="d-grid gap-3" style="grid-template-columns: 1fr 2fr;">
  <div class="bg-body-tertiary border rounded-3 sticky-top" style="min-height: 100px; padding: 15px; margin-top: 15px;">
    <h3>We are open for:</h3>
    <h5>Designer, Developer</h5>
    {% if can_applicate %}
      <button class="btn btn-primary"
            hx-get="{% url 'projects:apply' project.pk %}"
            hx-target="#modal-body"
            hx-trigger="click"
            data-bs-toggle="modal"
            data-bs-target="#applicationModal">
        Подать заявку
    </button>
    {% endif %}
  </div>
<div class="bg-body-tertiary border rounded-3" style="min-height: 100px; padding: 15px; margin-top: 15px;">
  <h3>Ratings:</h3>
    {% if project.ratings.all %}
    <ul>
      {% for rating in project.ratings.all %}
        <li>{{ rating.user.username }} – Score: {{ rating.score }}
            {% if rating.comment %}- Comment: {{ rating.comment }}{% endif %}
        </li>
      {% empty %}
        <li>No ratings yet.</li>
      {% endfor %}
    </ul>
    {% else %}
      <h2>No ratings yet.</h2>
    {% endif %}

    {% if can_rate %}
      <button class="btn btn-primary"
              hx-get="{% url 'projects:project_rate' project.pk %}"
              hx-target="#rating-dialog">
        Rate this project
      </button>
    {% endif %}
</div>
</div>
<div class="bg-body-tertiary border rounded-3" style="min-height: 100px; padding: 15px; margin-top: 15px;">
  <h3>Ratings:</h3>
    {% if project.ratings.all %}
    <ul>
      {% for rating in project.ratings.all %}
        <li>{{ rating.user.username }} – Score: {{ rating.score }}
            {% if rating.comment %}- Comment: {{ rating.comment }}{% endif %}
        </li>
      {% empty %}
        <li>No ratings yet.</li>
      {% endfor %}
    </ul>
    {% else %}
      <h2>No ratings yet.</h2>
    {% endif %}

    {% if can_rate and project.development_stage == 'deployed'%}
      <button class="btn btn-primary"
              hx-get="{% url 'projects:project_rate' project.pk %}"
              hx-target="#rating-dialog">
        Rate this project
      </button>
    {% endif %}
</div>
{% if current_membership and current_membership.role in "LEAD,PM,Mentor" %}
  <a href="{% url 'projects:project_edit' project.pk %}" class="btn btn-secondary mb-3">Edit Project Info</a>
  <a href="{% url 'projects:project_edit_stage' project.pk%}">Update Stage</a>
  <a href="{% url 'projects:task_create' project.pk %}" class="btn btn-primary mb-3">Add Task</a>
{% endif %}

<div class="modal fade" id="applicationModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Applicate</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
      </div>
      <div class="modal-body" id="modal-body">
        <div class="text-center p-3">Loading...</div>
      </div>
    </div>
  </div>
</div>

<hr>

<div class="modal fade" id="ratingModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content" id="rating-dialog">
      <div class="modal-header">
        <h5 class="modal-title">Rate Project</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
      </div>
    </div>
  </div>
</div>


{% else %}
  <p>We don’t find this project</p>
{% endif %}
{% endblock %}
